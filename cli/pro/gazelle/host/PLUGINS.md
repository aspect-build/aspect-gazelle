# Starzelle API

## Extension registration

#### `aspect.register_rule_kind`

Register a new rule kind that may be generated by a `configure` extension.

*Args*:
- `name`: the name of the rule kind
- `From`: the target .bzl file that defines the rule
- `NonEmptyAttrs`: a set of attributes that, if present, disqualify a rule from being deleted after merge.
- `MergeableAttrs`: a set of attributes that should be merged before dependency resolution
- `ResolveAttrs`: a set of attributes that should be merged after dependency resolution

#### `aspect.register_configure_extension`

Register a `configure` extension for generating targets in BUILD files.

*Args*:
- `name`: a unique identifier for the extension, may be referenced in Starlark API or used in `# aspect:{name} enabled|disabled` directives etc
- `properties`: a list of property definitions (optional)
- `prepare`: the prepare stage callback (optional)
- `analyze`: the analyze stage callback (optional)
- `declare`: the declare stage callback (optional)

## Stages

Starzelle has multiple stages for generating BUILD files which extensions can hook into:

1. Prepare
2. Analyze
3. Declare

All stages are optional for extensions.

Stages are executed per BUILD file. BUILD files may or may not be pre-existing depending on the `# aspect:generation_mode update|create`.

Stages are executed in sequence, however within a stage extensions may be executed in parallel.

### Prepare(ctx PrepareContext) PrepareResult

Declares which files the extension will process and any queries to run on those files.

**PrepareContext**:

The context for a `Prepare` invocation.

Properties:
* `.repo_name`: the name of the Bazel repository
* `.rel`: the directory being prepared relative to the repository root
* `.properties`: a name:value map of extension property values configured in BUILD files via `# aspect:{name} {value}`

**aspect.PrepareResult(sources, queries)**:

The factory method for a `Prepare` result.

Args:
* `sources`: a list of files to process
* `queries`: a `name:aspect.*Query` map of queries to run on matching files

**aspect.AstQuery(grammar, filter, query)**:

The factory method for an `AstQuery`.

Args:
* `filter`: a glob pattern to match file names to query
* `grammar`: the tree-sitter grammar to parse source code as
* `query`: a tree-sitter query to run on the source code AST

Tree-sitter capture nodes are returned in the `QueryResult.captures`.

See [tree-sitter](https://tree-sitter.github.io/tree-sitter/) for more information on ASTs, queries etc.

**aspect.RegexQuery(filter, re)**:

The factory method for a `RegexQuery`.

Args:
* `filter`: a glob pattern to match file names to query
* `re`: a regular expression to run on the file

Regex capture groups are returned in the `QueryResult.captures`, named by the group name,
as well as the matched text in the `QueryResult.result`.

See the [golang regex](https://pkg.go.dev/regexp) documentation for more information.

**aspect.RawQuery(filter)**:

The factory method for a `RawQuery`, returning file content as-is with no parsing or filtering.

Args:
* `filter`: a glob pattern to match file names to return

**aspect.JsonQuery(filter, query)**:

The factory method for a `JsonQuery`.

Args:
* `filter`: a glob pattern to match file names to query
* `query`: a JQ filter expression to run on the JSON document

See the [jq manual](https://jqlang.github.io/jq/manual/#basic-filters) for query expressions.
See [golang jq](https://github.com/itchyny/gojq) for information on the golang implementation used by starzelle.

### Analyze(ctx AnalyzeContext) error

Analyze source code query results and potentially declare symbols importable by rules.

Properties:
* `.source`: a `aspect.TargetSource` of the source file being analyzed

Methods:
**`.add_symbol(id, provider_type, label)`**: add a symbol to the symbol database.

Args:
* `id`: the symbol identifier
* `provider_type`: the type of the provider such as "java_info" for java packages etc
* `label`: the Bazel label producing the sybol

**aspect.TargetSource**:

Metadata about a source file being analyzed.

Properties:
* `.path`: the path to the source file relative to the BUILD
* `.query_results`: a `name:QueryResult` map

**aspect.QueryResult**:

The result of a query on a source file.

Properties:
* `.captures`: a `name:value` map of captures from the query


**aspect.Label(repo, pkg, name)**

Construct a Bazel label.

Args:
* `repo`: the repository name (optional)
* `pkg`: the label package (optional)
* `name`: the label name

### DeclareTargets(ctx DeclareTargetsContext) DeclareTargetsResult

Declare targets to be generated in the BUILD file given the declaration context

**DeclareTargetsContext**:

The context for a `DeclareTargets` invocation.

Properties:
* `.repo_name`: the name of the Bazel repository
* `.rel`: the directory being prepared relative to the repository root
* `.properties`: a name:value map of extension property values configured in BUILD files via `# aspect:{name} {value}`
* `.sources`: a list of `aspect.TargetSource`s to process based on the `prepare` stage results
* `.targets`: existing targets in the BUILD file
