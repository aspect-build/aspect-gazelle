load("@aspect_gazelle//:gazelle.bzl", "gazelle_generation_test")

BUILTIN_PLUGINS_DIR = "plugins"

# Disable the gazelle extensions
# gazelle:exclude .

KOTLIN_TESTS = [t.replace("/WORKSPACE", "") for t in glob(["*/WORKSPACE"])]

[
    gazelle_generation_test(
        name = "%s_test" % t,
        data = [
            "//%s:kotlin.lang.star" % BUILTIN_PLUGINS_DIR,
            "//%s:maven.lang.star" % BUILTIN_PLUGINS_DIR,
        ],
        dir = t,
        env = {
            "TEST_STARZELLE_PLUGINS": BUILTIN_PLUGINS_DIR,
        },
        gazelle_binary = "//tests:gazelle_orion_binary",
    )
    for t in KOTLIN_TESTS
    # TODO(#7623): remove opt-outs
    if t.replace("kotlin/", "") not in [
        "deep_import",
        "gcsutil",
        "simple_file2",

        # TODO: starzelle bzlmod support
        "simple_module",
        "simple_module_repo_name",
    ]
]
